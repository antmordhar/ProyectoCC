name: Java CI
#Cuando se haga un push
on: [push]

jobs:
  build:
    strategy:
      matrix:
        #Para las Ãºltimas version de Ubuntu
        platform: [ubuntu-latest]
        #Para las versiones del JDK 8
        JDK: [8]
        #Para las versiones de mongo
        mongodb-version: ["4.2"]
    
    #Corre en todas las plataformas de la matriz
    runs-on: ${{ matrix.platform }}
    
    steps:
    - uses: actions/checkout@v1
    #Le indicamos el nombre del paso
    - name: Set up JDK ${{ matrix.JDK }}
      uses: actions/setup-java@v1
      with:
        #Corre en todos los JDK quele hemos indicado
        java-version: ${{ matrix.JDK }}
    - name: Launch MongoDB
      uses: wbari/start-mongoDB@v0.2
      with:
        mongoDBVersion: ${{ matrix.mongodb-version }}
    - name: set environment variables
      uses: allenevans/set-env@v1.0.0
      with:
          HOST: 'localhost'
      #Le indicamos el nombre del paso
    - name: Build with Maven
      #Va a proyecto
      #Limpia los archivos de builds antiguas y lo empaqueta de nuevo instalando las dependencias.
      #Se corren los tests
      #Se corren los test de covertura
      run: |
       make install;
       java -jar ./Cocina/target/RestauranProjectCocina-0.0.1-SNAPSHOT.jar &;
       cd ./Mesas;
       mvn clean package cobertura:cobertura --file pom.xml;
       kill -9 $(sudo lsof -t -i:8081);
       cd ..;
       java -jar ./Camarero/target/RestauranProjectCamarero-0.0.1-SNAPSHOT.jar &;
       cd ./Cocina;
       mvn clean package cobertura:cobertura --file pom.xml;
       kill -9 $(sudo lsof -t -i:8082);
       cd ..;
       cd ./Camarero;
       mvn clean package cobertura:cobertura --file pom.xml;
       cd ..;
       java -jar ./Mesas/target/RestauranProject-0.0.1-SNAPSHOT.jar &;
       java -jar ./Cocina/target/RestauranProjectCocina-0.0.1-SNAPSHOT.jar &;
       java -jar ./Camarero/target/RestauranProjectCamarero-0.0.1-SNAPSHOT.jar &;
       cd ./APIService;
       mvn clean package cobertura:cobertura --file pom.xml;
